rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions for Admin Checks ---
    function isPrimaryAdmin() {
      // Primary Admin Check (fixed UID)
      return request.auth != null && request.auth.uid == "04amtH9UgfTWxPH0rqn2quaKiNf1"; // <<< YOUR ACTUAL PRIMARY ADMIN_UID
    }

    function isAssignedAdmin() {
      // Assigned Admin Check (reads the user's own document)
      // This requires the user document to exist and have an 'isAdmin' field.
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function canPerformGeneralAdminActions() {
      // A user can perform general admin actions if they are the Primary Admin OR an Assigned Admin.
      return isPrimaryAdmin() || isAssignedAdmin();
    }

    // --- Usernames: Publicly readable, Owner or Primary Admin creates, Primary Admin deletes ---
    match /usernames/{username} {
        allow read: if true;
        allow create: if request.auth != null &&
                         (request.resource.data.userId == request.auth.uid || isPrimaryAdmin());
        allow delete: if request.auth != null && isPrimaryAdmin();
        allow update: if false; // Prevent direct updates to username registry
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Read: Owner or any General Admin
      allow read: if request.auth != null && (request.auth.uid == userId || canPerformGeneralAdminActions());

      // Create: Only the user themselves can create their document
      allow create: if request.auth != null && request.auth.uid == userId;

      // Delete: Owner or Primary Admin
      allow delete: if request.auth != null && (request.auth.uid == userId || isPrimaryAdmin());

      // Update:
      allow update: if request.auth != null &&
                       (
                         // Case 1: Owner updates their own document
                         (request.auth.uid == userId &&
                           // Owner CANNOT update 'isAdmin'
                           !request.resource.data.diff(resource.data).affectedKeys().has('isAdmin') &&
                           // Allow all other specified fields for owner update
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                               'username', 'displayName', 'photoURL', 'completedCourseBadges',
                               'onboardingComplete', 'email', 'status', 'lastSelectedSubjectId',
                               'credits', 'appData', 'userNotes', 'userAiChatSettings' // Added userAiChatSettings
                           ])
                         ) ||
                         // Case 2: Primary Admin updates OTHER users' documents
                         (isPrimaryAdmin() && userId != request.auth.uid &&
                           // Primary Admin CAN update 'isAdmin' and 'credits' for others, plus other fields
                           request.resource.data.diff(resource.data).affectedKeys()
                             .hasOnly(['username', 'displayName', 'photoURL', 'completedCourseBadges',
                                       'onboardingComplete', 'email', 'status', 'lastSelectedSubjectId',
                                       'isAdmin', 'credits', 'appData', 'userNotes', 'userAiChatSettings' // Added userAiChatSettings
                                       ])
                         ) ||
                         // Case 3: Primary Admin updates THEIR OWN document
                         (isPrimaryAdmin() && userId == request.auth.uid &&
                           // Primary Admin CANNOT update their own 'isAdmin' status (it's inherent)
                           !request.resource.data.diff(resource.data).affectedKeys().has('isAdmin') &&
                           // Primary Admin CAN update their own allowed fields
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                               'username', 'displayName', 'photoURL', 'completedCourseBadges',
                               'onboardingComplete', 'email', 'status', 'lastSelectedSubjectId',
                               'credits', 'appData', 'userNotes', 'userAiChatSettings' // Added userAiChatSettings
                           ])
                         )
                       );

      // --- User Subcollections ---
      match /inbox/{messageId} {
        allow read, update: if request.auth != null && request.auth.uid == userId; // Owner
        allow create: if request.auth != null && canPerformGeneralAdminActions(); // Any Admin can send (create)
        allow delete: if request.auth != null && (request.auth.uid == userId || canPerformGeneralAdminActions()); // Owner or any Admin
      }

      match /userFormulaSheets/{sheetId} {
        allow read, write: if request.auth != null && request.auth.uid == userId; // Owner
        allow read, delete: if request.auth != null && canPerformGeneralAdminActions();   // Any Admin can read/delete
      }

      match /userChapterSummaries/{summaryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId; // Owner
        allow read, delete: if request.auth != null && canPerformGeneralAdminActions();   // Any Admin can read/delete
      }

      match /creditLog/{logId} {
        allow read: if request.auth != null && (request.auth.uid == userId || isPrimaryAdmin()); // Owner or Primary Admin
        allow create: if request.auth != null &&
                         (
                           (request.auth.uid == userId && request.resource.data.performedBy == userId) || // User action logging
                           isPrimaryAdmin() // Primary admin initiated action
                         );
        allow update, delete: if false; // Logs are immutable
      }

      // NEW: AI Chat Sessions Subcollection
      match /aiChatSessions/{sessionId} {
        allow read, write, create, delete: if request.auth != null && request.auth.uid == userId; // Owner only
      }
    }

    // --- User Course Progress: Owner or any General Admin can manage ---
    match /userCourseProgress/{userId}/{courses=**} { // Wildcard for courses subcollection
       allow read, write, create, delete: if request.auth != null && (request.auth.uid == userId || canPerformGeneralAdminActions());
    }

    // --- User Exam Storage: Owner manages read/write/create/delete, any General Admin can read ---
    match /userExams/{userId}/{exams=**} { // Wildcard for exams subcollection
       allow read, write, create, delete: if request.auth != null && request.auth.uid == userId;
       allow read: if request.auth != null && canPerformGeneralAdminActions();
    }

    // --- Feedback & Exam Issues: Authenticated users create, any General Admin manages ---
    match /feedback/{feedbackId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && canPerformGeneralAdminActions();
    }
    match /examIssues/{issueId} {
       allow create: if request.auth != null;
       allow read, update, delete: if request.auth != null && canPerformGeneralAdminActions();
    }

    // --- Course Definitions ---
    match /courses/{courseId} {
      allow read: if true; // Publicly readable

      // Create: Authenticated user, status depends on role
      allow create: if request.auth != null &&
                       request.resource.data.creatorUid == request.auth.uid &&
                       (
                         // Non-Admin (neither Primary nor Assigned) creates as 'pending'
                         (request.resource.data.status == 'pending' && !isPrimaryAdmin() && !isAssignedAdmin()) ||
                         // Primary Admin or Assigned Admin can create as 'approved' OR 'pending'
                         ( (request.resource.data.status == 'approved' || request.resource.data.status == 'pending') && (isPrimaryAdmin() || isAssignedAdmin()) )
                       ) &&
                       // Fields allowed on creation (important for security)
                       request.resource.data.keys().hasOnly([
                         'name', 'description', 'majorTag', 'subjectTag', 'youtubePlaylistUrls',
                         'creatorUid', 'creatorName', 'createdAt', 'status', 'reportedBy',
                         'reportReason', 'chapterResources', 'imageUrl', 'coverUrl', 'courseDirName',
                         'prerequisites', 'corequisites', 'totalChapters', 'chapters', 'relatedSubjectId',
                         'creatorIsAdmin' // Store if creator was an admin at time of creation
                       ]);

      // Update & Delete: Only Primary Admin or an Assigned Admin
      allow update, delete: if request.auth != null && canPerformGeneralAdminActions();
    }

    // --- Shared Notes: Public read, Auth create, Owner/any General Admin manage update/delete ---
    match /sharedCourseNotes/{noteId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && (request.auth.uid == resource.data.userId || canPerformGeneralAdminActions());
    }

    // --- Admin Tasks: Only Primary Admin can manage ---
    match /adminTasks/{taskId} {
      allow read, write, create, delete: if request.auth != null && isPrimaryAdmin();
    }

    // --- Task Versions: Only Primary Admin can manage ---
    match /taskVersions/{versionId} {
      allow read, write, create, delete: if request.auth != null && isPrimaryAdmin();
    }

    // --- Global Chat Messages ---
    match /globalChatMessages/{messageId} {
      allow read: if request.auth != null; // Authenticated users can read
      allow create: if request.auth != null && request.auth.uid != null && request.resource.data.senderId == request.auth.uid; // Authenticated users can create their own messages
      // Delete: Owner or any General Admin
      allow delete: if request.auth != null && (request.auth.uid == resource.data.senderId || canPerformGeneralAdminActions());
      // Update: Any General Admin, but only for 'isPinned' field
      allow update: if request.auth != null && canPerformGeneralAdminActions() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPinned']);
    }

    // --- Settings Collection ---
    match /settings/{settingDocId} {
      // aiPrompts document within settings
      match /aiPrompts {
        allow read: if request.auth != null; // Authenticated users can read global prompts
        allow write: if request.auth != null && isPrimaryAdmin(); // Only Primary Admin can write
      }
      // chat document within settings
      match /chat {
        allow read, write: if request.auth != null && isPrimaryAdmin(); // Only Primary Admin can r/w global chat settings
      }
      // Add rules for other specific setting documents if created
    }

    // --- Deprecated Global Caches: Read allowed, Write by Primary Admin ---
    match /globalFormulaSheets/{sheetId} {
        allow read: if true;
        allow write: if request.auth != null && isPrimaryAdmin();
    }
    match /globalChapterSummaries/{summaryId} {
        allow read: if true;
        allow write: if request.auth != null && isPrimaryAdmin();
    }
  }
}