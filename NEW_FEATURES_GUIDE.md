# Lyceum Course Automation & Google Drive Integration: New Features Guide

This document provides an overview of the new course content automation features and Google Drive cloud storage integration for the Lyceum platform. It covers feature descriptions, configuration requirements, and important considerations for administrators.

## 1. Feature Summaries

The following sections detail the five main automation features implemented:

### 1.1. Lecture Transcription Automation

*   **Purpose**: To automatically transcribe video lectures from YouTube URLs into SRT (SubRip Text) format and store them for course use.
*   **Access & Use**:
    *   In the Admin Panel, navigate to the section typically handling course content or specific admin tools (this UI is managed in `admin_course_content.js`).
    *   Look for the UI section titled "**The Digital Scribe: Lecture Transcriber**".
*   **Admin Inputs**:
    *   YouTube Lecture URL.
    *   Target Course and Chapter for associating the transcript.
    *   AssemblyAI API Key (prompted in UI).
    *   Google Drive is used for storage; authentication is handled server-side (API Key/Service Account).
*   **Expected Output & Storage**:
    *   An SRT transcript file (e.g., `VideoTitle_TranscriptID.srt`) is generated.
    *   This SRT file is uploaded to Google Drive in the course-specific folder: `LyceumCourses_GoogleDrive_Test/<courseDirName>/Transcriptions_Archive/`.
    *   A link/ID to this Google Drive SRT file, along with the video title and other metadata, is saved in the course's Firestore document under `chapterResources.[chapterId].lectureUrls`.
*   **Considerations**:
    *   Requires a valid AssemblyAI API key with credits.
    *   Transcription accuracy depends on audio quality and AssemblyAI's service.
    *   The process involves downloading audio, uploading to AssemblyAI, and polling for results, which can take several minutes per lecture.
    *   Google Drive is used for storage, configured on the server.

### 1.2. Textbook PDF Addition and Splitting

*   **Purpose**: To upload a full textbook PDF, process its Table of Contents (ToC) using AI, split it into chapter-based PDFs, and store both the full textbook and individual chapters on Google Drive.
*   **Access & Use**:
    *   In the Admin Panel, find the section titled "**PDF Alchemist's Bench**".
*   **Admin Inputs**:
    *   Full Textbook PDF file.
    *   Target Course for association.
    *   "Actual Page 1 Number": The PDF page number that corresponds to page '1' of the actual textbook content (to calibrate ToC page numbers).
    *   Google Gemini API Key (prompted, for ToC analysis).
    *   Google Drive is used for storage, configured on the server.
*   **Expected Output & Storage**:
    *   The full textbook PDF is uploaded to Google Drive: `LyceumCourses_GoogleDrive_Test/<courseDirName>/Textbook_Full/textbook_full_FILENAME.pdf`.
    *   Individual chapter PDFs are created and uploaded to Google Drive: `LyceumCourses_GoogleDrive_Test/<courseDirName>/Textbook_Chapters/Ch_X_ChapterTitle.pdf`.
    *   Firestore Updates:
        *   The course document is updated with `gdriveTextbookFullPdfId` and/or `gdriveTextbookFullPdfWebLink`.
        *   `chapterResources` for the course is updated. Each chapter identified gets an entry (e.g., `textbook_chapter_X`) in `chapterResources`, and within its `otherResources` array, a link/ID to its specific chapter PDF on Google Drive is stored with `type: 'textbook_chapter_segment'`.
*   **Considerations**:
    *   Requires a Google Gemini API Key.
    *   The accuracy of ToC extraction and chapter splitting depends on the PDF's structure and Gemini's ability to interpret the ToC images. `pdf-image` (which wraps `pdftoppm` or Ghostscript) is used for converting PDF pages to images for AI analysis; this means **ImageMagick or Ghostscript must be installed on the server environment where `pdf_processing_service.js` runs.**
    *   Processing large PDFs can be time-consuming and resource-intensive.

### 1.3. PDF Chapter MCQ and Problems Generation

*   **Purpose**: To generate Multiple Choice Questions (MCQs) and practice problems in Markdown format from individual chapter PDF content.
*   **Access & Use**:
    *   In the Admin Panel, find the section titled "**Oracle's Forge (Chapter PDF Q-Gen)**".
*   **Admin Inputs**:
    *   Target Course.
    *   Target Chapter (selected from a dropdown populated with chapters that have an associated `textbook_chapter_segment` PDF, generated by the "Textbook PDF Addition and Splitting" feature).
    *   The Google Drive link/ID to the chapter PDF is automatically retrieved.
    *   Google Gemini API Key (prompted).
    *   Google Drive is used for storage, configured on the server.
*   **Expected Output & Storage**:
    *   Two Markdown files are generated: `TextMCQ.md` and `TextProblems.md`.
    *   These files are uploaded to Google Drive: `LyceumCourses_GoogleDrive_Test/<courseDirName>/Generated_Assessments/<chapterKey>/`. (`<chapterKey>` is like `textbook_chapter_1`).
    *   Firestore Updates: The course's `chapterResources.[chapterKey].otherResources` array is updated with links/IDs to these generated Markdown files on Google Drive, using types `generated_mcq_markdown` and `generated_problems_markdown`.
*   **Considerations**:
    *   Requires a Google Gemini API Key.
    *   The quality and relevance of generated questions depend on the clarity of the chapter PDF text and Gemini's capabilities.
    *   The AI uses `example_TextMCQ.md` and `example_TextProblems.md` as syntax guides.
    *   Requires the target chapter PDF to have been previously processed and stored on Google Drive by the "Textbook PDF Addition and Splitting" feature.

### 1.4. Lecture MCQ and Problems Generation

*   **Purpose**: To generate MCQs and practice problems in Markdown format from the textual content of one or more lecture SRT transcripts.
*   **Access & Use**:
    *   In the Admin Panel, find the section titled "**Oracle's Forge (Lecture Q-Gen)**".
*   **Admin Inputs**:
    *   Target Course.
    *   "Chapter Name / Topic": A user-defined name for the collection of questions being generated (this will form a new "chapter-like" entry in Firestore).
    *   Selection of one or more lecture SRT transcripts (from a list populated with available transcripts for the chosen course, now from Google Drive).
    *   Google Gemini API Key (prompted).
    *   Google Drive is used for storage, configured on the server.
*   **Expected Output & Storage**:
    *   Two Markdown files are generated: `LecturesMCQ.md` and `LecturesProblems.md`.
    *   A new unique key (e.g., `SanitizedTopicName_lecture_topic_uuid`) is generated for this content.
    *   Files are uploaded to Google Drive: `LyceumCourses_GoogleDrive_Test/<courseDirName>/Generated_Assessments/<new_chapter_key>/`.
    *   Firestore Updates: A new entry using `new_chapter_key` is added to the course's `chapterResources`. This entry stores the provided topic name, `contentType: 'lecture_derived'`, references to the source lecture SRTs (their Google Drive IDs/links), and links/IDs to the generated Markdown files in its `otherResources` array (types `generated_lecture_mcq_markdown`, `generated_lecture_problems_markdown`).
*   **Considerations**:
    *   Requires a Google Gemini API Key.
    *   Quality depends on the accuracy and completeness of the lecture SRT transcripts.
    *   The AI uses `example_TextMCQ.md` and `example_TextProblems.md` as syntax guides, but prompts are tailored for lecture content.

### 1.5. Google Drive Database Management UI & Migration

*   **Purpose**: To provide a unified interface for managing course migration to Google Drive, establishing a standard folder structure, and browsing/interacting with files stored on Google Drive.
*   **Access & Use**:
    *   In the Admin Panel, this is the main section titled "**Google Drive Cloud Command Center**".
    *   **Course Migration**: Lists all courses, showing their Google Drive migration status. Admins can initiate migration for courses not yet fully migrated. This creates a standard folder structure on Google Drive (`LyceumCourses_GoogleDrive_Test/<courseDirName>/` with subfolders `Transcriptions_Archive`, `Textbook_Chapter_Vault`, `Generated_Assessments`) and uploads placeholder README files. Links/IDs to these folders are saved in Firestore.
    *   **File Explorer**: Integrated within the same UI section, titled "**Google Drive Cloud Navigator**". Admins can:
        *   Enter a Google Drive folder ID to load its contents (or leave blank for root).
        *   Navigate through folders ("Open Folder", "Parent Folder" (Up button), clickable path breadcrumbs).
        *   View file/folder names, types, and sizes (where available from API).
        *   Download files (initiates browser download via `google_drive_service.js`).
        *   Upload files to the currently viewed folder.
*   **Admin Inputs**:
    *   For Migration & File Explorer: Google Drive authentication is handled by `google_drive_service.js` using API Key for initialization and OAuth for operations if needed (user interaction might be required for OAuth consent). No direct email/password prompts for Google Drive itself in the UI.
    *   For File Explorer: Google Drive folder ID (optional, defaults to root). File for upload.
*   **Expected Output & Storage**:
    *   Migration: Standardized course folder structure on Google Drive, updated Firestore links/IDs (`gdriveCourseRootFolderId`, `gdriveTranscriptionsFolderId`, etc.).
    *   File Explorer: Display of folder contents, file downloads, file uploads to specified Google Drive locations.
*   **Considerations**:
    *   The "Migrate to Google Drive" process standardizes the main folder structure. Content from other automation features (like specific SRTs or chapter PDFs) populates these folders.
    *   The file explorer's download functionality is handled by `google_drive_service.js`.
    *   The file explorer's upload functionality assumes `google_drive_service.js`'s `uploadFile` can handle browser `File` objects.
    *   The migration status check is based on the presence of the key Google Drive folder IDs in Firestore.
    *   The gamified alert "🚀 Blast off to the future!" encourages migration of remaining courses to Google Drive.

## 2. Configuration and Setup Guide

For these new features to operate correctly, the following configurations and setups are essential:

*   **Google Drive API Key & Service Account (Server-Side)**:
    *   Used by: `google_drive_service_server.js` and all server-side services that interact with Google Drive (`lecture_transcription_service.js`, `pdf_processing_service.js`, `pdf_question_generation_service.js`, `lecture_question_generation_service.js`).
    *   How: The `google_drive_service_server.js` should be initialized with a Google API Key and ideally a path to a Service Account JSON key file. This is typically configured on the server via environment variables or a secure configuration file. Client-side admin actions trigger server endpoints that then use this pre-configured Google Drive service.

*   **Google Drive API Key & OAuth Client ID (Client-Side)**:
    *   Used by: `google_drive_service.js` for client-side operations like the File Explorer or direct-to-Drive features in the admin panel.
    *   How: The `google_drive_service.js` is initialized with an API Key. For operations requiring user-specific permissions, an OAuth 2.0 flow would be initiated, requiring a Client ID configured in the Google Cloud Console and in `google_drive_service.js`.

*   **AssemblyAI API Key**:
    *   Used by: `lecture_transcription_service.js` (via an API call from `pdf-server.js` or equivalent).
    *   How: Prompted in the "Lecture Transcription Automator" UI and passed to the server endpoint. The server then uses this key to communicate with the AssemblyAI API.

*   **Google Gemini API Key**:
    *   Used by: `ai_integration_server.js` (if called from server-side services like `pdf_processing_service.js`, etc.).
    *   How: Can be prompted in admin UIs and passed to server endpoints, or the server can use a globally configured Gemini API key.

*   **Server Setup (`pdf-server.js` or equivalent main server file)**:
    *   **Running Server**: The Express server must be running. It hosts the local API endpoints.
    *   **`multer` Configuration**: If file uploads are passed through the server before going to Google Drive (e.g., lecture files for transcription), `multer` in `pdf-server.js` handles temporary storage.
    *   **Body Parsers**: `express.json()` is used.

*   **External System Dependencies for PDF Processing**:
    *   `pdf_processing_service.js` uses `pdf-image` (requires **ImageMagick or Ghostscript + Poppler** on the server).

*   **Firestore Rules**:
    *   Ensure rules allow admin users or the server (with admin privileges/service account) to write/update course documents with Google Drive links/IDs (e.g., `gdriveCourseRootFolderId`, `chapterResources.[key].otherResources[...].gdriveId`).

*   **Example Markdown Files for AI Prompts**:
    *   `example_TextMCQ.md`, `example_TextProblems.md` remain essential for guiding AI question generation.

## 3. Legacy Course Compatibility

The introduction of Google Drive cloud storage for new and migrated courses is designed to enhance performance and scalability. Legacy courses must remain functional.

*   **Student-Facing Content Fetching**: This was **outside the scope of these admin panel and backend service modifications**.
*   **Recommended Fallback Logic**:
    1.  **Check for Google Drive Links/IDs**: First, check for Google Drive specific fields (e.g., `gdriveTranscriptionsFolderId`, `chapterResources.[key].otherResources[...].gdriveId`).
    2.  **Use Google Drive Asset if Available**: If a Google Drive asset exists, use it.
    3.  **Fallback to Legacy Path**: If not found, attempt to load via the legacy method.
*   **Data Structure Consistency**: New features populate Firestore with Google Drive structures. Fetching logic must handle both.

This dual-check approach ensures access regardless of migration status.

## 4. Code File Overview

The following key JavaScript files were created or significantly modified:

*   **`admin_course_content.js`**:
    *   **Role**: Central hub for admin panel UI related to course automation.
    *   **Contains**: UI rendering, event handlers, client-side logic for initiating operations by calling server endpoints or directly interacting with `google_drive_service.js` for client-side Google Drive operations.

*   **`google_drive_service.js`**:
    *   **Role**: Client-side service for interacting with Google Drive API via GAPI.
    *   **Contains**: Functions for `initialize` (API Key, OAuth setup), `findFolder`, `createFolder`, `uploadFile` (browser `File` object), `downloadFile`, `getFolderContents`.

*   **`google_drive_service_server.js`**:
    *   **Role**: Server-side service for Node.js interaction with Google Drive API.
    *   **Contains**: Functions for `initialize` (API Key, Service Account), `findFolder`, `createFolder`, `uploadFile` (local path), `downloadFile` (local path), `getFolderContents`.

*   **`lecture_transcription_service.js`** (Server-side):
    *   **Role**: Handles transcription of YouTube lectures.
    *   **Contains**: Logic to download audio, use AssemblyAI, generate SRT, upload SRT to Google Drive (via `google_drive_service_server.js`).

*   **`pdf_processing_service.js`** (Server-side):
    *   **Role**: Manages processing of full textbook PDFs.
    *   **Contains**: Logic to upload full PDF to Google Drive, extract ToC (using `pdf-image` & AI), split PDF, upload chapters to Google Drive.

*   **`pdf_question_generation_service.js`** (Server-side):
    *   **Role**: Generates MCQs/problems from chapter PDF text.
    *   **Contains**: Logic to download PDF from Google Drive, extract text, use AI (Gemini) for questions, upload Markdowns to Google Drive.

*   **`lecture_question_generation_service.js`** (Server-side):
    *   **Role**: Generates MCQs/problems from lecture SRTs.
    *   **Contains**: Logic to download SRTs from Google Drive, use AI for questions, upload Markdowns to Google Drive.

*   **`pdf-server.js`** (or main server file):
    *   **Role**: Express.js server hosting API endpoints.
    *   **Contains**: Routes calling server-side service functions. Handles HTTP, parameters, `multer`.

*   **`ai_integration_server.js`** (Formerly `ai_integration.js` if it was refactored to be server-focused for these tasks):
    *   **Role**: Centralizes interactions with Google Gemini AI API (server-side context).
    *   **Contains**: Functions to format requests and return AI responses.

This guide should help administrators understand, configure, and utilize the new automation capabilities of the Lyceum platform with Google Drive integration.
